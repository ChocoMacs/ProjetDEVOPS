pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                // Cloner le dépôt Git
                git url: 'https://github.com/ChocoMacs/ProjetDEVOPS', branch: 'main'
            }
        }
        stage('Parallel Scans') {
            parallel {
                stage('Dependency Check') {
                    steps {
                        script {
                            // Scanner les dépendances pour les vulnérabilités avec OWASP Dependency-Check
                            dependencyCheck additionalArguments: '--format ALL', 
                                            installation: 'Dependency-Check', 
                                            odir: 'dependency-check-report', 
                                            scm: false
                        }
                    }
                }
                stage('Trivy Vulnerability Scan') {
                    steps {
                        script {
                            // List all Docker images and run Trivy scan on each
                            echo 'Running vulnerability scan with Trivy on all Docker images...'
                            sh '''
                                images=$(docker images --format "{{.Repository}}:{{.Tag}}")
                                for image in $images; do
                                    trivy image --exit-code 1 --severity HIGH,CRITICAL $image
                                done
                            '''
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Le pipeline CI s\'est terminé avec succès.'
        }
        failure {
            echo 'Le pipeline CI a échoué.'
        }
    }
}
